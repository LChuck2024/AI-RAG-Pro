# 向量数据库原理

## 什么是向量数据库

向量数据库是专门用于存储和检索高维向量的数据库系统。在RAG系统中，向量数据库用于存储文档的嵌入向量，支持高效的相似度检索。

## 为什么需要向量数据库

### 传统数据库的局限

传统关系型数据库（如MySQL、PostgreSQL）擅长处理结构化数据和精确匹配，但在语义搜索方面存在局限：
- 无法直接进行语义相似度计算
- 关键词匹配无法理解语义
- 不适合高维向量数据

### 向量数据库的优势

1. **语义理解**：基于向量相似度，理解语义关系
2. **高效检索**：优化的索引结构，支持快速相似度搜索
3. **可扩展性**：支持大规模向量数据
4. **灵活性**：支持多种相似度度量方法

## 向量数据库工作原理

### 1. 向量化

文档首先通过嵌入模型转换为向量：
- 每个文档被分割成chunk
- 每个chunk通过嵌入模型生成向量
- 向量维度通常为384、768、1024等

### 2. 索引构建

向量数据库使用特殊的索引结构加速检索：

#### 倒排索引（Inverted Index）
- 适用于稀疏向量
- 记录每个维度上的非零值
- 支持快速查找

#### 树形索引（Tree-based Index）
- **KD-Tree**：适用于低维向量
- **Ball Tree**：适用于高维向量
- **Annoy**：近似最近邻搜索

#### 图索引（Graph-based Index）
- **HNSW**（Hierarchical Navigable Small World）
- 构建多层图结构
- 支持快速近似最近邻搜索

#### 量化索引（Quantization）
- **PQ**（Product Quantization）
- **LSH**（Locality Sensitive Hashing）
- 压缩向量，减少存储和计算

### 3. 相似度计算

常用的相似度度量方法：

#### 余弦相似度（Cosine Similarity）
```
similarity = (A · B) / (||A|| × ||B||)
```
- 范围：[-1, 1]
- 关注向量方向，忽略长度
- 适用于文本相似度

#### 欧氏距离（Euclidean Distance）
```
distance = √Σ(Ai - Bi)²
```
- 范围：[0, +∞]
- 考虑向量长度和方向
- 距离越小，相似度越高

#### 点积（Dot Product）
```
similarity = A · B
```
- 范围：(-∞, +∞)
- 简单快速
- 需要向量归一化

### 4. 检索流程

1. **查询向量化**：将用户问题转换为向量
2. **索引查找**：在索引中查找相似向量
3. **相似度计算**：计算查询向量与候选向量的相似度
4. **排序返回**：按相似度排序，返回top-k结果

## ChromaDB简介

ChromaDB是本系统使用的向量数据库，具有以下特点：

### 特性

1. **易用性**：简单的Python API
2. **轻量级**：可以嵌入到应用中
3. **持久化**：支持数据持久化存储
4. **可扩展**：支持分布式部署

### 核心概念

- **Collection**：向量集合，类似数据库的表
- **Document**：文档对象，包含文本和元数据
- **Embedding**：文档的向量表示
- **Query**：查询请求，包含查询向量和参数

### 使用示例

```python
import chromadb

# 创建客户端
client = chromadb.Client()

# 创建集合
collection = client.create_collection("documents")

# 添加文档
collection.add(
    documents=["文档内容"],
    embeddings=[[0.1, 0.2, ...]],  # 向量
    ids=["doc1"],
    metadatas=[{"source": "file1.txt"}]
)

# 查询
results = collection.query(
    query_embeddings=[[0.1, 0.2, ...]],  # 查询向量
    n_results=5  # 返回top-5
)
```

## 性能优化

### 1. 索引选择

- **小规模数据**（<10万）：使用精确搜索
- **中等规模**（10万-100万）：使用HNSW
- **大规模**（>100万）：使用量化+近似搜索

### 2. 向量维度

- 权衡准确性和效率
- 通常384-1024维
- 使用PCA降维（可选）

### 3. 批量操作

- 批量添加文档
- 批量查询
- 减少网络开销

### 4. 缓存策略

- 缓存热门查询
- 缓存常用文档向量
- 使用LRU等缓存算法

## 常见问题

### Q: 向量数据库和传统数据库的区别？

A: 
- 传统数据库：结构化数据，精确匹配
- 向量数据库：高维向量，相似度搜索

### Q: 如何选择向量维度？

A: 
- 考虑嵌入模型的输出维度
- 权衡准确性和效率
- 通常使用模型默认维度

### Q: 相似度阈值如何设置？

A: 
- 根据实际效果调整
- 通常0.7-0.9（余弦相似度）
- 通过A/B测试确定

### Q: 如何处理大规模数据？

A: 
- 使用分布式向量数据库
- 分片存储
- 使用近似搜索算法

## 未来发展方向

1. **混合检索**：结合向量检索和关键词检索
2. **多模态支持**：支持图像、音频等向量
3. **实时更新**：支持实时向量更新
4. **智能路由**：根据查询类型选择检索策略

